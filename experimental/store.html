<html>
<body>
<script>

'use strict';

var Store = {};
(function(exports) {
	function makeNode(initial, sources, name) {
		let node = {
			_dependents: [],
			_name: name,
			_value: initial,
			_add: function(node) {
				this._dependents.push(node);
			}
		};

		sources.forEach(function(source) {
			source._add(node);
		});

		return node;
	}

	function propagate(changed) {
		let available = new Set(changed);
		let hot = new Set(changed);
		let cold = new Set();

		let fifo = Array.from(changed);
		for (let i = 0; i < fifo.length; i++) {
			fifo[i]._dependents.forEach(function(dependent) {
				if (available.has(dependent)) {
					return hot.add(dependent);
				}

				if (dependent._update(available, cold)) {
					hot.add(dependent);
					fifo.push(dependent);
				}
			});
		}

		return hot;
	}

	exports.state = function(initial, name) {
		let result = makeNode(initial, [], name);
		result._set = function(value) {
			result._value = value;
		};
		result._update = function(available) {
			available.add(result);
			return true;
		};
		return result;
	};

	exports.dependent = function(sources, func, name) {
		let values = sources.map(source => source._value);
		let initial = func(...values);

		let result = makeNode(initial, sources, name);
		result._update = function(available, cold) {
			if (sources.every(source => !cold.has(source)) && sources.every(source => available.has(source) || source._update(available, cold))) {
				let values = sources.map(source => source._value);

				let value = func(...values);
				if (value !== undefined) {
					result._value = value;
					available.add(result);
					return true;
				}
			}

			cold.add(result);
			return false;
		};
		return result;
	};

	let setter = null;
	exports.transaction = function(scope) {
		if (setter) {
			scope(setter);
			return;
		}

		let changed = new Set();

		setter = function(node, value) {
			node._set(value);
			changed.add(node);
		};

		scope(setter);
		setter = null;

		return propagate(changed);
	};
})(Store);

let a = Store.state(1, 'a');
let b = Store.state(2, 'b');

let c = Store.dependent([a, b], (a, b) => (a > 2) ? a + b : undefined, 'c');
let d = Store.dependent([a, c], (a, c) => a * c, 'd');

function output(nodes) {
	nodes.forEach(function(node) {
		console.log(node._name, node._value);
	});
}

function trans(scope) {
	console.log('TRANSACTION');
	output(Store.transaction(scope));
}

trans(function(set) {
	set(a, 2);
});

trans(function(set) {
	set(a, 3);
	set(b, 4);
});

</script>
</body>
</html>